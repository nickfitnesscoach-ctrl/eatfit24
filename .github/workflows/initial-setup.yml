name: Initial VPS Setup

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY" to confirm initial deployment'
        required: true
        default: ''

jobs:
  setup-vps:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DEPLOY'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          MISSING_SECRETS=""

          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS VPS_HOST"
          fi

          if [ -z "${{ secrets.VPS_USERNAME }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS VPS_USERNAME"
          fi

          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            MISSING_SECRETS="$MISSING_SECRETS VPS_SSH_KEY"
          fi

          if [ -n "$MISSING_SECRETS" ]; then
            echo "âŒ Missing required secrets:$MISSING_SECRETS"
            exit 1
          fi

          echo "âœ… All required secrets are configured"

      - name: Initial VPS Setup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "ðŸ“¦ Starting initial VPS setup..."

            # Create project directory
            echo "ðŸ“ Creating /opt/EatFit24 directory..."
            mkdir -p /opt/EatFit24
            cd /opt/EatFit24

            # Check if git is installed
            if ! command -v git &> /dev/null; then
              echo "ðŸ“¥ Installing git..."
              apt-get update
              apt-get install -y git
            fi

            # Clone repository or update if exists
            if [ -d ".git" ]; then
              echo "ðŸ”„ Repository exists, pulling latest changes..."
              git fetch origin
              git reset --hard origin/main
            else
              echo "ðŸ“¥ Cloning repository..."
              git clone https://github.com/nickfitnesscoach-ctrl/fitness-app.git .
            fi

            echo "âœ… Repository setup complete"

            # Check Docker installation
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker is not installed on VPS"
              echo "Please install Docker first: https://docs.docker.com/engine/install/"
              exit 1
            fi

            # Check Docker Compose installation
            if ! command -v docker compose &> /dev/null && ! command -v docker-compose &> /dev/null; then
              echo "âŒ Docker Compose is not installed on VPS"
              echo "Please install Docker Compose first"
              exit 1
            fi

            echo "âœ… Docker and Docker Compose are installed"

            # Create .env file template if doesn't exist
            if [ ! -f ".env" ]; then
              echo "ðŸ“ Creating .env file template..."
              cat > .env << 'EOF'
            # =============================================================================
            # DATABASE CONFIGURATION
            # =============================================================================
            POSTGRES_DB=foodmind
            POSTGRES_USER=foodmind
            POSTGRES_PASSWORD=CHANGE_ME_$(openssl rand -hex 16)
            POSTGRES_HOST=db
            POSTGRES_PORT=5432

            # =============================================================================
            # DJANGO BACKEND CONFIGURATION
            # =============================================================================
            DJANGO_SETTINGS_MODULE=config.settings.production
            SECRET_KEY=CHANGE_ME_$(openssl rand -hex 32)
            DEBUG=False
            ALLOWED_HOSTS=eatfit24.ru,www.eatfit24.ru
            CORS_ALLOWED_ORIGINS=https://eatfit24.ru,https://www.eatfit24.ru

            # =============================================================================
            # TELEGRAM BOT CONFIGURATION
            # =============================================================================
            TELEGRAM_BOT_TOKEN=CHANGE_ME
            BOT_ADMIN_ID=310151740

            # =============================================================================
            # AI API CONFIGURATION
            # =============================================================================
            OPENROUTER_API_KEY=CHANGE_ME

            # =============================================================================
            # TELEGRAM ADMINS (Backend)
            # =============================================================================
            TELEGRAM_ADMINS=310151740

            # =============================================================================
            # OPTIONAL: SWAGGER AUTH (Backend)
            # =============================================================================
            SWAGGER_AUTH_USERNAME=admin
            SWAGGER_AUTH_PASSWORD=CHANGE_ME
            EOF
              echo "âš ï¸  .env file created with placeholders!"
              echo "âš ï¸  YOU MUST EDIT /opt/EatFit24/.env and set real values!"
              echo ""
              echo "Run on VPS: nano /opt/EatFit24/.env"
            else
              echo "âœ… .env file already exists"
            fi

            echo ""
            echo "ðŸŽ‰ Initial setup complete!"
            echo ""
            echo "ðŸ“‹ Next steps:"
            echo "1. SSH to VPS: ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}"
            echo "2. Edit .env: nano /opt/EatFit24/.env"
            echo "3. Set real values for:"
            echo "   - POSTGRES_PASSWORD"
            echo "   - SECRET_KEY"
            echo "   - TELEGRAM_BOT_TOKEN"
            echo "   - OPENROUTER_API_KEY"
            echo "4. Start services: cd /opt/EatFit24 && docker compose up -d"
            echo ""
            echo "Current directory structure:"
            ls -la /opt/EatFit24

      - name: Summary
        if: always()
        run: |
          echo "ðŸ Initial setup workflow complete!"
          echo ""
          echo "If successful:"
          echo "1. SSH to your VPS"
          echo "2. Configure /opt/EatFit24/.env with real secrets"
          echo "3. Run: cd /opt/EatFit24 && docker compose up -d"
          echo "4. Check status: docker ps"
