name: Deploy to VPS (EatFit24)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Опционально) - быстрый тест, если есть
      # - name: Run tests
      #   run: |
      #     echo "TODO: add tests"

      - name: Deploy via SSH (sudo)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script_stop: true
          script: |
            set -euo pipefail

            PROJECT_DIR="/opt/EatFit24"
            BRANCH="main"

            echo ">>> Who am I"
            whoami
            pwd

            echo ">>> Ensuring project dir exists"
            sudo -S -p "" bash -c "mkdir -p ${PROJECT_DIR}" <<< "${{ secrets.VPS_SUDO_PASSWORD }}"

            echo ">>> Fixing ownership (prevents 'dubious ownership' forever)"
            sudo -S -p "" bash -c "chown -R ${USER}:${USER} ${PROJECT_DIR}" <<< "${{ secrets.VPS_SUDO_PASSWORD }}"

            echo ">>> Mark as safe directory for git (extra safety)"
            git config --global --add safe.directory "${PROJECT_DIR}" || true

            echo ">>> Updating repo"
            cd "${PROJECT_DIR}"

            # Если репо ещё не инициализировано на сервере (первый деплой)
            if [ ! -d ".git" ]; then
              echo ">>> Repo not found, cloning..."
              git clone --branch "${BRANCH}" --depth 1 "https://github.com/${{ github.repository }}.git" .
            else
              git fetch origin
              git reset --hard "origin/${BRANCH}"
            fi

            echo ">>> Docker compose version"
            sudo -S -p "" docker compose version <<< "${{ secrets.VPS_SUDO_PASSWORD }}"

            echo ">>> Pull/build/restart services (db не трогаем)"
            # Важно: db обычно не билдится и его перезапускать без нужды не надо
            sudo -S -p "" docker compose up -d --build redis backend celery-worker celery-beat <<< "${{ secrets.VPS_SUDO_PASSWORD }}"

            echo ">>> (Optional) restart bot too"
            # Если бот живёт в этом же compose - раскомментируй
            sudo -S -p "" docker compose up -d --build bot <<< "${{ secrets.VPS_SUDO_PASSWORD }}"

            echo ">>> Show containers"
            sudo -S -p "" docker compose ps <<< "${{ secrets.VPS_SUDO_PASSWORD }}"

            echo ">>> Basic health checks"
            # backend health
            curl -fsS http://127.0.0.1:8000/health/ >/dev/null && echo "✅ backend health OK"

            # redis ping
            sudo -S -p "" docker compose exec -T redis redis-cli ping <<< "${{ secrets.VPS_SUDO_PASSWORD }}" | grep -q PONG && echo "✅ redis OK"

            # celery ping (через worker контейнер)
            sudo -S -p "" docker compose exec -T celery-worker celery -A config inspect ping <<< "${{ secrets.VPS_SUDO_PASSWORD }}" | grep -q pong && echo "✅ celery worker OK"

            echo "✅ Deploy completed"
