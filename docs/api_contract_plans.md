# API Contract: AI Personal Plan

SSOT ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –±–æ—Ç –∏ backend –æ–±—è–∑–∞–Ω—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–ø—Ä–æ—Å–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ AI-–ø–ª–∞–Ω–∞.
–õ—é–±–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –±–∞–≥–æ–º.

–û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

–ü–ª–∞–Ω –Ω–µ–ª—å–∑—è –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –ø–æ–∫–∞ –æ–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ë–î

–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –æ–±—è–∑–∞–Ω –±—ã—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º—ã–º

–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã

–û—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –ø–æ–ª–µ–∑–Ω—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∏
–ó–∞–≥–æ–ª–æ–≤–æ–∫	–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ	–ü—Ä–∞–≤–∏–ª–∞
X-Request-ID	ID –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏	–û–±—è–∑–∞—Ç–µ–ª–µ–Ω. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –±–æ—Ç–æ–º. Backend –æ–±—è–∑–∞–Ω –≤–µ—Ä–Ω—É—Ç—å —Ç–æ—Ç –∂–µ ID –≤ –æ—Ç–≤–µ—Ç–µ
X-Bot-Secret	–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –±–æ—Ç–∞	–û–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

‚ùó –ï—Å–ª–∏ X-Request-ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞.

## Workflow (–ø–æ–ª–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

```
1. POST /api/telegram/users/get-or-create/
   ‚Üì —Å–æ–∑–¥–∞—ë—Ç/–ø–æ–ª—É—á–∞–µ—Ç TelegramUser

2. GET /api/telegram/personal-plan/count-today/?telegram_id=XXX
   ‚Üì –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç (max 3 –ø–ª–∞–Ω–∞ –≤ —Å—É—Ç–∫–∏)

3. POST /api/telegram/personal-plan/survey/
   ‚Üì —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç survey_id

4. [–ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç AI-—Ç–µ–∫—Å—Ç –ø–ª–∞–Ω–∞]
   ‚Üì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OpenRouter API

5. POST /api/telegram/personal-plan/plan/
   ‚Üì —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–ª–∞–Ω ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç plan

6. [–ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
   ‚úÖ –ü–ª–∞–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
```

---

## –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### 0Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**POST /api/telegram/users/get-or-create/**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏—è TelegramUser –∏ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ Django User.

**Request body:**
```json
{
  "telegram_id": 12345678,
  "username": "nickname",      // optional
  "full_name": "–ò–º—è –§–∞–º–∏–ª–∏—è"  // optional
}
```

**Response (200 OK –∏–ª–∏ 201 Created):**
```json
{
  "id": 1,
  "user_id": 42,
  "telegram_id": 12345678,
  "username": "nickname",
  "first_name": "–ò–º—è",
  "last_name": "–§–∞–º–∏–ª–∏—è",
  "created_at": "2026-01-12T10:00:00Z"
}
```

**–û—à–∏–±–∫–∏:**
| HTTP | error.code | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–∞ |
|------|------------|----------|----------------|
| 400 | VALIDATION_ERROR | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | ‚ùå –ë–µ–∑ retry |

---

### 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–ª–∞–Ω–æ–≤

**GET /api/telegram/personal-plan/count-today/?telegram_id=XXX**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω –ø–ª–∞–Ω —Å–µ–≥–æ–¥–Ω—è.

**Query params:**
- `telegram_id` (required): Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Response (200 OK):**
```json
{
  "count": 2,           // –°–æ–∑–¥–∞–Ω–æ –ø–ª–∞–Ω–æ–≤ —Å–µ–≥–æ–¥–Ω—è
  "limit": 3,           // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –≤ –¥–µ–Ω—å
  "can_create": true    // –ú–æ–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞—Ç—å –µ—â—ë –ø–ª–∞–Ω
}
```

**–û—à–∏–±–∫–∏:**
| HTTP | error.code | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–∞ |
|------|------------|----------|----------------|
| 400 | VALIDATION_ERROR | telegram_id –Ω–µ —É–∫–∞–∑–∞–Ω | ‚ùå –ë–µ–∑ retry |
| 404 | USER_NOT_FOUND | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω | ‚ùå –ë–µ–∑ retry |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:**
- –≠—Ç–æ—Ç endpoint –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è UX: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Å—Ç–∞–ª–æ—Å—å
- –†–µ–∞–ª—å–Ω—ã–π enforcement –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `POST /plan/`

---

### 2Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø—Ä–æ—Å–∞

**POST /api/telegram/personal-plan/survey/**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ–ø—Ä–æ—Å.

**Request body:**
```json
{
  "telegram_id": 12345678,
  "gender": "male",                    // "male" | "female"
  "age": 30,
  "height_cm": 180,
  "weight_kg": 85.5,
  "target_weight_kg": 75.0,           // optional
  "activity": "moderate",              // "sedentary" | "light" | "moderate" | "active" | "very_active"
  "training_level": "beginner",        // optional: "beginner" | "intermediate" | "advanced"
  "body_goals": ["lose_weight"],       // optional: list of goal codes
  "health_limitations": ["back_pain"], // optional: list of limitation codes
  "body_now_id": 123,                  // Telegram file_id —Ç–µ–∫—É—â–µ–≥–æ —Ñ–æ—Ç–æ
  "body_now_file": "AgACAgIAA...",     // Telegram file_id (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
  "body_now_label": "–ù–∞—á–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞", // optional
  "body_ideal_id": 456,                // Telegram file_id –∂–µ–ª–∞–µ–º–æ–≥–æ —Ñ–æ—Ç–æ
  "body_ideal_file": "AgACAgIAA...",   // Telegram file_id (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
  "body_ideal_label": "–ò–¥–µ–∞–ª",         // optional
  "timezone": "Europe/Moscow",
  "utc_offset_minutes": 180
}
```

**Response (201 Created):**
```json
{
  "id": 77,
  "user": 42,
  "gender": "male",
  "age": 30,
  "height_cm": 180,
  "weight_kg": 85.5,
  "target_weight_kg": 75.0,
  "activity": "moderate",
  "training_level": "beginner",
  "body_goals": ["lose_weight"],
  "health_limitations": ["back_pain"],
  "body_now_id": 123,
  "body_now_file": "AgACAgIAA...",
  "body_now_label": "–ù–∞—á–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞",
  "body_ideal_id": 456,
  "body_ideal_file": "AgACAgIAA...",
  "body_ideal_label": "–ò–¥–µ–∞–ª",
  "timezone": "Europe/Moscow",
  "utc_offset_minutes": 180,
  "completed_at": "2026-01-12T10:30:00Z",
  "created_at": "2026-01-12T10:30:00Z"
}
```

**–û—à–∏–±–∫–∏:**
| HTTP | error.code | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–∞ |
|------|------------|----------|----------------|
| 400 | VALIDATION_ERROR | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (age < 0, weight <= 0, etc) | ‚ùå –ë–µ–∑ retry |
| 404 | USER_NOT_FOUND | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å telegram_id –Ω–µ –Ω–∞–π–¥–µ–Ω | ‚ùå –ë–µ–∑ retry |
| 500 | SURVEY_SAVE_FAILED | –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î | üîÅ –†–∞–∑—Ä–µ—à—ë–Ω retry |

–ü–æ–≤–µ–¥–µ–Ω–∏–µ

Backend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–ø—Ä–æ—Å–∞

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç survey_id (–ø–æ–ª–µ `id` –≤ response), –∫–æ—Ç–æ—Ä—ã–π –¥–∞–ª–µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞

–û—Ç–≤–µ—Ç—ã
–°—Ç–∞—Ç—É—Å	–ó–Ω–∞—á–µ–Ω–∏–µ
201 Created	–û–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
–ü—Ä–∏–º–µ—á–∞–Ω–∏—è

–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (–Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ) –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–Ω

---

### 3Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞

**POST /api/telegram/personal-plan/plan/**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –ø–ª–∞–Ω–∞ –±–æ—Ç–æ–º.

**–ö–ª—é—á–µ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**

‚ö†Ô∏è –ü–ª–∞–Ω —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–Ω—ã–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ backend.
–î–æ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –±–æ—Ç **–ù–ï –ò–ú–ï–ï–¢ –ü–†–ê–í–ê** –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

**Request body:**
```json
{
  "telegram_id": 12345678,
  "survey_id": 77,              // optional, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
  "ai_text": "–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω:\n1. ...",
  "ai_model": "anthropic/claude-3.5-sonnet",  // optional
  "prompt_version": "v2.1"      // optional
}
```

**Response (201 Created - –ø–ª–∞–Ω —Å–æ–∑–¥–∞–Ω –≤–ø–µ—Ä–≤—ã–µ):**
```json
{
  "id": 42,
  "user": 1,
  "survey": 77,
  "ai_text": "–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω:\n1. ...",
  "ai_model": "anthropic/claude-3.5-sonnet",
  "prompt_version": "v2.1",
  "created_at": "2026-01-12T10:45:00Z"
}
```

**Response (200 OK - –ø–ª–∞–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å):**
```json
{
  "id": 42,
  "user": 1,
  "survey": 77,
  "ai_text": "–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω:\n1. ...",
  "ai_model": "anthropic/claude-3.5-sonnet",
  "prompt_version": "v2.1",
  "created_at": "2026-01-12T10:45:00Z"
}
```

‚ö†Ô∏è **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –ø–ª–∞–Ω**, –∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π (–µ—Å–ª–∏ `survey_id` —Å–æ–≤–ø–∞–¥–∞–µ—Ç).

**–£—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:**
| –°—Ç–∞—Ç—É—Å | –ö–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è |
|--------|-------------------|
| 201 Created | –ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω –≤–ø–µ—Ä–≤—ã–µ |
| 200 OK | –ü–ª–∞–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å) |

**–û—à–∏–±–∫–∏ (—Å—Ç—Ä–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ):**
| HTTP | error.code | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–∞ |
|------|------------|----------|----------------|
| 400 | VALIDATION_ERROR | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—É—Å—Ç–æ–π ai_text, etc) | ‚ùå –ë–µ–∑ retry |
| 404 | USER_NOT_FOUND | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å telegram_id –Ω–µ –Ω–∞–π–¥–µ–Ω | ‚ùå –ë–µ–∑ retry |
| 404 | SURVEY_NOT_FOUND | –û–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é | ‚ùå –ë–µ–∑ retry |
| 429 | DAILY_LIMIT_REACHED | –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç (–º–∞–∫—Å. 3 –ø–ª–∞–Ω–∞ –≤ —Å—É—Ç–∫–∏) | ‚ùå –ë–µ–∑ retry, –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ |
| 500 | PLAN_SAVE_FAILED | –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î | üîÅ –†–∞–∑—Ä–µ—à—ë–Ω retry |

**–§–æ—Ä–º–∞—Ç –æ—à–∏–±–∫–∏ (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω):**
```json
{
  "status": "error",
  "error": {
    "code": "PLAN_SAVE_FAILED",
    "message": "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω",
    "details": "Internal database error",
    "request_id": "f9a1c2e4-..."
  }
}
```

---

## –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

### Backend –æ–±—è–∑–∞–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:

**–§–æ—Ä–º–∞—Ç:**
```
<RID> | user_id=XXX | survey_id=YYY | plan_id=ZZZ | status
```

**–ü—Ä–∏–º–µ—Ä—ã:**
```
f9a1c2e4... | user_id=12345 | survey_id=77 | plan_id=42 | created
a3b4c5d6... | user_id=12345 | survey_id=77 | plan_id=42 | already_exists (200)
e7f8g9h0... | user_id=12345 | survey_id=None | error=DAILY_LIMIT_REACHED
```

### –ë–æ—Ç –æ–±—è–∑–∞–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:

**–§–æ—Ä–º–∞—Ç:**
```
<RID> | endpoint | http_status | error.code (if error)
```

**–ü—Ä–∏–º–µ—Ä—ã:**
```
f9a1c2e4... | POST /plan/ | 201 | success
a3b4c5d6... | POST /plan/ | 500 | PLAN_SAVE_FAILED
e7f8g9h0... | POST /plan/ | 429 | DAILY_LIMIT_REACHED
```

**–¶–µ–ª—å:**
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É –æ—Ç –∫–Ω–æ–ø–∫–∏ –≤ Telegram –¥–æ SQL-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

**–ü–æ–∏—Å–∫ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–∞–ª—É–µ—Ç—Å—è –Ω–∞ –æ—à–∏–±–∫—É
2. –ò—â–µ–º –≤ –ª–æ–≥–∞—Ö –±–æ—Ç–∞ –ø–æ telegram_id ‚Üí –ø–æ–ª—É—á–∞–µ–º RID
3. –ò—â–µ–º –≤ –ª–æ–≥–∞—Ö backend –ø–æ RID ‚Üí –≤–∏–¥–∏–º SQL-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
4. Profit!

---

## Retry-–ø–æ–ª–∏—Ç–∏–∫–∞ (—Å—Ç—Ä–æ–≥–æ)

### üîÅ –†–∞–∑—Ä–µ—à—ë–Ω –ø–æ–≤—Ç–æ—Ä (retry)

- **–¢–∞–π–º–∞—É—Ç—ã** (httpx.TimeoutException)
- **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏** (httpx.HTTPError, connection refused)
- **502 Bad Gateway** (backend –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è)
- **503 Service Unavailable** (backend –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
- **504 Gateway Timeout** (backend –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è)
- **500 PLAN_SAVE_FAILED** (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –ë–î)
- **500 SURVEY_SAVE_FAILED** (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –ë–î)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ retry (–≤ –±–æ—Ç–µ):**
```python
max_attempts = 3
wait = exponential(multiplier=1, min=1s, max=10s)
```

### ‚õî –ó–∞–ø—Ä–µ—â—ë–Ω –ø–æ–≤—Ç–æ—Ä (no retry)

- **429 DAILY_LIMIT_REACHED** (–ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω, –ø–æ–≤—Ç–æ—Ä –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω)
- **400 VALIDATION_ERROR** (–¥–∞–Ω–Ω—ã–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã, –ø–æ–≤—Ç–æ—Ä –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω)
- **403 FORBIDDEN** (X-Bot-Secret –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–≤—Ç–æ—Ä –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω)
- **404 USER_NOT_FOUND** (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–≤—Ç–æ—Ä –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω)
- **404 SURVEY_NOT_FOUND** (–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–≤—Ç–æ—Ä –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω)

**–ü—Ä–∞–≤–∏–ª–æ:**
–ë–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –±–∏–∑–Ω–µ—Å-–æ—à–∏–±–∫–∞—Ö (4xx, –∫—Ä–æ–º–µ 408).
–¢–æ–ª—å–∫–æ –ø—Ä–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö (5xx, —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏).

---

## –ì–∞—Ä–∞–Ω—Ç–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞

–ï—Å–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å–æ–±–ª—é–¥—ë–Ω:

- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–≤–∏–¥–∏—Ç** ¬´–ø–ª–∞–Ω, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è¬ª
- ‚ùå –í –ë–î **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç** –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (UniqueConstraint + idempotency)
- ‚úÖ **–õ—é–±–æ–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç** –º–æ–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –ø–æ X-Request-ID
- ‚úÖ **–ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã** –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ
- ‚úÖ **–õ–∏–º–∏—Ç—ã** —Ä–∞–±–æ—Ç–∞—é—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ (select_for_update)
- ‚úÖ **Race conditions** –∏—Å–∫–ª—é—á–µ–Ω—ã (database-level locks)

---

## –í–∞–ª–∏–¥–∞—Ü–∏—è (backend)

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è survey:
- `telegram_id` (int, > 0)
- `gender` ("male" | "female")
- `age` (int, 10‚Äì120)
- `height_cm` (int, 50‚Äì250)
- `weight_kg` (float, 20‚Äì300)
- `activity` (str, –æ–¥–∏–Ω –∏–∑: "sedentary", "light", "moderate", "active", "very_active")
- `body_now_id` (int)
- `body_now_file` (str)
- `body_ideal_id` (int)
- `body_ideal_file` (str)
- `timezone` (str, –≤–∞–ª–∏–¥–Ω—ã–π timezone)
- `utc_offset_minutes` (int, -720 –¥–æ +840)

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è plan:
- `telegram_id` (int, > 0)
- `ai_text` (str, min length = 10)

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è:
- `survey_id` (int) - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–ª—è —Å–≤—è–∑–∏ —Å –æ–ø—Ä–æ—Å–æ–º
- `ai_model` (str) - –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- `prompt_version` (str) - –¥–ª—è A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### X-Bot-Secret validation:

**Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
```python
expected = settings.TELEGRAM_BOT_API_SECRET
provided = request.headers.get("X-Bot-Secret")

if not provided or provided != expected:
    return 403 Forbidden
```

**–ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:**
```python
headers = {
    "X-Bot-Secret": settings.TELEGRAM_BOT_API_SECRET,
    "X-Request-ID": str(uuid.uuid4()),
    "X-Forwarded-Proto": "https"
}
```

**–í–∞–∂–Ω–æ:**
- ‚ùå –°–µ–∫—Ä–µ—Ç –ù–ï –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ query params
- ‚ùå –°–µ–∫—Ä–µ—Ç –ù–ï –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ body
- ‚úÖ –°–µ–∫—Ä–µ—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –≤ headers
- ‚úÖ Backend **–Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** –≤ production –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–∞ (fail-fast)

---

## –°—Ç–∞—Ç—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞

- **SSOT:** ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- **Production-ready:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ production
- **–û–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –±–æ—Ç–∞ –∏ backend:** ‚úÖ Mandatory
- **–í–µ—Ä—Å–∏—è:** v1.1 (2026-01-12)
- **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-12 (–¥–æ–±–∞–≤–ª–µ–Ω—ã request/response schemas, GET endpoint, –≤–∞–ª–∏–¥–∞—Ü–∏—è)